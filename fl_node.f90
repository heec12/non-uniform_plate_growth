!  Calculations of forces from stresses
subroutine fl_node
use arrays

include 'precision.inc'
include 'params.inc'
include 'arrays.inc'

    !  1 - 3
    !  |   |
    !  2 - 4
    !
    !  diagonal / :
    !
    !   A:        B:
    !
    !  1---3         1
    !  | /         / |
    !  2         2---3
    !
    !  diagonal \ :
    !
    !   C:        D:
    !
    !  1          1---3
    !  | \         \  |
    !  2---3          2
    !
    !    assemblage of forces is COUNTRE CLOCK-WISE !
    !

boff = 0
!!! ratfac adjustment
! ratfac = 0.25
!Fbdyleft(:) = (/8.91655528e+09, 1.32104212e+10, 1.02163732e+10, 8.69006410e+09, &
!      6.16383783e+09,  3.12755036e+09, -2.24731516e+06, -2.82775717e+09, &
!     -5.34281948e+09, -7.28816307e+09, -8.13734468e+09, -9.70823934e+09, &
!     -1.54754995e+10, -1.83185238e+10, -2.87205046e+10, -5.17257378e+10, &
!     -8.90053669e+10, -1.23362234e+11, -1.41760149e+11, -1.53419067e+11, &
!     -1.62874644e+11, -1.71544188e+11, -1.79931282e+11, -1.88220361e+11, &
!     -1.96471970e+11, -2.04703600e+11, -2.12924995e+11, -2.21139109e+11, &
!     -2.29353165e+11, -2.37563349e+11, -2.45778691e+11, -2.53991251e+11, &
!     -2.62212179e+11, -2.70427255e+11, -2.78653092e+11, -2.86863819e+11, &
!     -2.95090477e+11, -3.03287848e+11, -3.11525102e+11, -3.19631297e+11, -1.61362967e+11/)
!Fbdyright(:) = (/-8.03964778e+09, -1.16770440e+10, -1.42461904e+10, -1.37339156e+10, &
!     -1.05303299e+10, -6.79090537e+09, -2.88899427e+09,  2.37017686e+09, &
!      8.61111882e+09,  1.59066993e+10,  2.20340081e+10,  2.50120297e+10, &
!      2.69619512e+10,  2.18323820e+10,  1.93952194e+10,  2.19363383e+10, &
!      4.79582565e+10,  9.48029550e+10,  1.32362733e+11,  1.50959409e+11, &
!      1.62212828e+11,  1.71168594e+11,  1.79533181e+11,  1.87723237e+11, &
!      1.95842662e+11,  2.03928046e+11,  2.11997624e+11,  2.20055163e+11, &
!      2.28110425e+11,  2.36158486e+11,  2.44212572e+11,  2.52260840e+11, &
!      2.60321371e+11,  2.68371453e+11,  2.76434207e+11,  2.84477029e+11, &
!      2.92540583e+11,  3.00574636e+11,  3.08645411e+11,  3.16572213e+11, 1.59834922e+11/)
!Fbdyleft(:) = (/6.49871239e+09,  9.73194640e+09,  6.59133173e+09,  5.47796631e+09, &
!      3.33725495e+09,  4.69606533e+08, -2.55100578e+09, -5.21910362e+09, &
!     -7.41284127e+09, -9.01106857e+09, -9.54141218e+09, -1.07836437e+10, &
!     -1.62674812e+10, -2.14791874e+10, -3.62299037e+10, -6.15563855e+10, &
!     -9.63229798e+10, -1.26800619e+11, -1.42760716e+11, -1.53689684e+11, &
!     -1.62873743e+11, -1.71461504e+11, -1.79840135e+11, -1.88137576e+11, &
!     -1.96397298e+11, -2.04634573e+11, -2.12859907e+11, -2.21076920e+11, &
!     -2.29293885e+11, -2.37507862e+11, -2.45726545e+11, -2.53942312e+11, &
!     -2.62166719e+11, -2.70386285e+11, -2.78618600e+11, -2.86834684e+11, &
!     -2.95067244e+11, -3.03267845e+11, -3.11511846e+11, -3.19605352e+11, -1.61315510e+11/)
!Fbdyright(:) = (/-7.27317668e+09, -1.03203168e+10, -1.30911095e+10, -1.24612861e+10, &
!    -9.27527082e+09, -5.61803070e+09, -1.70240226e+09,  3.44292729e+09, &
!     9.57990404e+09,  1.72363274e+10,  2.32405685e+10,  2.52661266e+10, &
!     2.62460314e+10,  2.16087234e+10,  1.98792395e+10,  2.63654360e+10, &
!     5.91836921e+10,  1.11653107e+11,  1.39620415e+11,  1.53559138e+11, &
!     1.62938505e+11,  1.71362704e+11,  1.79595454e+11,  1.87736768e+11, &
!     1.95843987e+11,  2.03929822e+11,  2.12007040e+11,  2.20076428e+11, &
!     2.28146708e+11,  2.36212797e+11,  2.44287036e+11,  2.52356249e+11, &
!     2.60437585e+11,  2.68507116e+11,  2.76586914e+11,  2.84647663e+11, &
!     2.92733275e+11,  3.00788617e+11,  3.08878357e+11,  3.16805490e+11, 1.59912121e+11/)
!Fbdyleft(:) = (/4.47066064e+09,  6.28915913e+09,  4.84222823e+09,  4.25937623e+09, &
!    2.58373337e+09, -7.74026492e+07, -2.98029214e+09, -5.62228930e+09, &
!   -7.81796755e+09, -9.41548122e+09, -1.00123718e+10, -1.11680755e+10, &
!   -1.70770345e+10, -2.61196336e+10, -4.24818915e+10, -6.95898291e+10, &
!   -1.02894593e+11, -1.30131606e+11, -1.44225907e+11, -1.54257840e+11, &
!   -1.63023994e+11, -1.71439987e+11, -1.79757934e+11, -1.88034871e+11, &
!   -1.96283273e+11, -2.04514645e+11, -2.12738834e+11, -2.20958319e+11, &
!   -2.29179212e+11, -2.37399009e+11, -2.45625089e+11, -2.53849127e+11, &
!   -2.62082766e+11, -2.70311064e+11, -2.78553958e+11, -2.86779508e+11, &
!   -2.95024649e+11, -3.03231919e+11, -3.11480928e+11, -3.19564164e+11, -1.61261354e+11/)
!Fbdyright(:) = (/-7.48778788e+09, -1.10010584e+10, -1.40534665e+10, -1.32395534e+10, &
!    -1.00254133e+10, -6.39044283e+09, -2.46527432e+09,  2.48803885e+09, &
!     8.92648395e+09,  1.71794457e+10,  2.31850609e+10,  2.45328750e+10, &
!     2.48384664e+10,  2.06985633e+10,  1.97437263e+10,  3.31033397e+10, &
!     7.04099812e+10,  1.19307071e+11,  1.42099012e+11,  1.53831549e+11, &
!     1.62727813e+11,  1.71120631e+11,  1.79349987e+11,  1.87512053e+11, &
!     1.95643587e+11,  2.03754833e+11,  2.11857129e+11,  2.19948685e+11, &
!     2.28041017e+11,  2.36131163e+11,  2.44229796e+11,  2.52324147e+11, &
!     2.60428780e+11,  2.68521997e+11,  2.76626148e+11,  2.84711695e+11, &
!     2.92821983e+11,  3.00894178e+11,  3.09001787e+11,  3.16906521e+11, 1.59865910e+11/)

! ratfac 0.5
!Fbdyleft(:) = (/-4.54475537e+09, -9.78069546e+09, -7.85494005e+09, -2.28027348e+09, &
!     1.07326251e+09,  4.39985805e+08, -1.67364675e+09, -3.93441402e+09, &
!    -6.10827224e+09, -7.86754863e+09, -8.84724612e+09, -1.03280882e+10, &
!    -1.57408633e+10, -2.03126941e+10, -3.36066890e+10, -5.71976739e+10, &
!    -9.31361457e+10, -1.25854709e+11, -1.42589877e+11, -1.53564164e+11, &
!    -1.62809276e+11, -1.71438367e+11, -1.79833422e+11, -1.88138477e+11, &
!    -1.96404918e+11, -2.04648377e+11, -2.12880452e+11, -2.21104964e+11, &
!    -2.29330408e+11, -2.37554240e+11, -2.45783352e+11, -2.54009303e+11, &
!    -2.62244213e+11, -2.70472533e+11, -2.78713746e+11, -2.86939893e+11, &
!    -2.95184798e+11, -3.03393665e+11, -3.11639240e+11, -3.19742036e+11, -1.61402946e+11/)
!Fbdyright(:) = (/-6.59827947e+09, -1.02631284e+10, -1.16708679e+10, -9.72818755e+09, &
!    -6.85743573e+09, -3.85659534e+09, -1.45099179e+08,  4.51762258e+09, &
!     1.01226721e+10,  1.60340621e+10,  1.93100786e+10,  2.06699160e+10, &
!     2.31216479e+10,  2.08311186e+10,  2.69409681e+10,  3.68765603e+10, &
!     7.08311179e+10,  1.17180110e+11,  1.40952073e+11,  1.54046021e+11, &
!     1.63379867e+11,  1.71755980e+11,  1.79951965e+11,  1.88094479e+11, &
!     1.96218494e+11,  2.04333874e+11,  2.12443986e+11,  2.20549223e+11, &
!     2.28656873e+11,  2.36761906e+11,  2.44874796e+11,  2.52985390e+11, &
!     2.61108428e+11,  2.69224531e+11,  2.77352529e+11,  2.85459000e+11, &
!     2.93583301e+11,  3.01678976e+11,  3.09809640e+11,  3.17806807e+11, 1.60468710e+11/)

! 86 model
!Fbdyleft(:) = (/-1.67835844e+10, -3.13437195e+10, -2.61577372e+10, -1.90186885e+10, &
!    -1.16003714e+10, -5.32382147e+09, -4.09895199e+09, -5.94245045e+09, &
!    -7.80754816e+09, -9.34953277e+09, -1.03112167e+10, -1.17971686e+10, &
!    -1.97205598e+10, -3.00704789e+10, -4.75395447e+10, -7.20722038e+10, &
!    -1.02629960e+11, -1.28424851e+11, -1.43327349e+11, -1.53791592e+11, &
!    -1.62827200e+11, -1.71395445e+11, -1.79794255e+11, -1.88119628e+11, &
!    -1.96408533e+11, -2.04675572e+11, -2.12930899e+11, -2.21177814e+11, &
!    -2.29423998e+11, -2.37667845e+11, -2.45917607e+11, -2.54165125e+11, &
!    -2.62422483e+11, -2.70674947e+11, -2.78941151e+11, -2.87190880e+11, &
!    -2.95457106e+11, -3.03688458e+11, -3.11953012e+11, -3.20079432e+11, -1.61603661e+11/)
!FbdyRight(:) = (/-4.03334025e+09, -7.83554254e+09, -7.07934304e+09, -5.77522063e+09, &
!    -3.27650047e+09, -8.72004975e+06, 3.59828298e+09, 7.61075434e+09, &
!     1.12653678e+10, 1.35081836e+10, 1.48231401e+10, 1.64141121e+10, &
!     2.19549567e+10, 4.05304264e+10, 6.34769613e+10, 8.14041927e+10, &
!     1.05078483e+11, 1.30083275e+11, 1.45333025e+11, 1.55585320e+11, &
!     1.64136783e+11, 1.72272966e+11, 1.80377637e+11, 1.88500889e+11, &
!     1.96635450e+11, 2.04777613e+11, 2.12926449e+11, 2.21077539e+11, &
!     2.29234484e+11, 2.37392689e+11, 2.45559357e+11, 2.53724789e+11, &
!     2.61901415e+11, 2.70073042e+11, 2.78258918e+11, 2.86427732e+11, &
!     2.94608537e+11, 3.02759646e+11, 3.10945367e+11, 3.19008719e+11, 1.61108523e+11/)
! D model
!Fbdyleft(:) = (/ 9.23595558e+09, -4.56360438e+09, -5.53899945e+09, -1.27145040e+10, &
!    -9.01882403e+09, -2.24939998e+10, -7.29985391e+09, -1.73281850e+10, &
!    -9.78016874e+09, -1.86289049e+10, -1.57499664e+10, -1.96039421e+10, &
!    -3.30106903e+10, -7.82050481e+10, -1.09137224e+11, -1.07325574e+11, &
!    -1.24922954e+11, -1.37466451e+11, -1.46533626e+11, -1.55405613e+11, &
!    -1.63619120e+11, -1.72117329e+11, -1.80494610e+11, -1.88831597e+11, &
!    -1.97133898e+11, -2.05414315e+11, -2.13680525e+11, -2.21936793e+11, &
!    -2.30183708e+11, -2.38425688e+11, -2.46665916e+11, -2.54907125e+11, &
!    -2.63155152e+11, -2.71415078e+11, -2.79695936e+11, -2.88000569e+11, &
!    -2.96330168e+11, -3.04667706e+11, -3.12994440e+11, -3.21289757e+11, -1.62744762e+11/)
!FbdyRight(:) = (/ 2.07825709e+09, -6.36432783e+09, -3.14339506e+09, -5.34381825e+09, &
!    -4.01269655e+09, 5.49752421e+09, 7.58069714e+09, -1.56791921e+09, &
!     6.96343206e+09, 1.13456636e+10, 2.41070892e+10, 2.96389776e+10, &
!     6.01470157e+10, 8.41381458e+10, 8.47524807e+10, 1.04493067e+11, &
!     1.19642993e+11, 1.39859852e+11, 1.48949368e+11, 1.56906518e+11, &
!     1.64932994e+11, 1.72903639e+11, 1.81042924e+11, 1.89162347e+11, &
!     1.97245555e+11, 2.05383178e+11, 2.13552232e+11, 2.21710146e+11, &
!     2.29868316e+11, 2.38030646e+11, 2.46193531e+11, 2.54362321e+11, &
!     2.62542466e+11, 2.70730305e+11, 2.78932170e+11, 2.87143830e+11, &
!     2.95361718e+11, 3.03577195e+11, 3.11779868e+11, 3.19978203e+11, 1.62038209e+11/)
! D61 model
!FbdyLeft(:) = (/-1.76898125e+10, -3.30509941e+10, -2.82601900e+10, -2.15606991e+10, &
!    -1.40896193e+10, -6.74508900e+09, -3.48667857e+09, -5.18517488e+09, &
!    -7.27078837e+09, -8.99537139e+09, -1.02017799e+10, -1.75982870e+10, &
!    -3.19639594e+10, -4.61013114e+10, -6.65808850e+10, -8.90471767e+10, &
!    -1.12394358e+11, -1.31981163e+11, -1.44745052e+11, -1.54513753e+11, &
!    -1.63261060e+11, -1.71690238e+11, -1.80020129e+11, -1.88311483e+11, &
!    -1.96583996e+11, -2.04845750e+11, -2.13102315e+11, -2.21354278e+11, &
!    -2.29608464e+11, -2.37862123e+11, -2.46123419e+11, -2.54383745e+11, &
!    -2.62653374e+11, -2.70916584e+11, -2.79189380e+11, -2.87446151e+11, &
!    -2.95720167e+11, -3.03965426e+11, -3.12239933e+11, -3.20374465e+11, -1.61775132e+11/)
!FbdyRight(:) = (/-5.65886643e+09, -1.00075813e+10, -8.77932983e+09, -7.19564895e+09, &
!    -4.49113566e+09, -1.34845206e+09, 1.88004935e+09, 5.00183014e+09, &
!     7.32632725e+09, 8.80184657e+09, 9.63137098e+09, 2.33589732e+10, &
!     5.59375735e+10, 7.56698017e+10, 8.94074197e+10, 1.03704229e+11, &
!     1.20906449e+11, 1.36808232e+11, 1.47520314e+11, 1.56240154e+11, &
!     1.64438716e+11, 1.72529184e+11, 1.80637832e+11, 1.88780507e+11, &
!     1.96944642e+11, 2.05121601e+11, 2.13308993e+11, 2.21502816e+11, &
!     2.29705145e+11, 2.37911537e+11, 2.46128998e+11, 2.54348569e+11, &
!     2.62580666e+11, 2.70806828e+11, 2.79042772e+11, 2.87260161e+11, &
!     2.95494017e+11, 3.03699413e+11, 3.11941496e+11, 3.20066012e+11, 1.61665429e+11/)

! change asymmetric direction
!FbdyLeft(:) = (/-1.11556761e+10, -2.39238354e+10, -2.03681978e+10, -1.03299415e+10, &
!    -3.26099561e+09, -3.85019074e+09, -7.25140874e+09, -9.97640021e+09, &
!    -1.20852768e+10, -1.35371196e+10, -1.42842827e+10, -1.59980904e+10, &
!    -2.12851654e+10, -2.38086190e+10, -3.42381674e+10, -5.70183026e+10, &
!    -9.29366160e+10, -1.27432341e+11, -1.45994522e+11, -1.56181816e+11, &
!    -1.64897836e+11, -1.73225834e+11, -1.81323232e+11, -1.89360325e+11, &
!    -1.97438868e+11, -2.05566210e+11, -2.13730807e+11, -2.21917114e+11, &
!    -2.30122028e+11, -2.38337355e+11, -2.46566020e+11, -2.54799809e+11, &
!    -2.63049324e+11, -2.71298463e+11, -2.79564969e+11, -2.87815042e+11, &
!    -2.96081265e+11, -3.04309694e+11, -3.12574549e+11, -3.20730359e+11, -1.62061756e+11/)
!FbdyRight(:) = (/3.32068872e+10, 6.24520348e+10, 5.54159849e+10, 4.76012159e+10, &
!     3.99339539e+10, 3.26337035e+10, 2.54317356e+10, 1.84252706e+10, &
!     1.15262512e+10, 7.00681849e+09, 7.38826805e+09, 8.99683853e+09, &
!     1.62214447e+10, 2.39264355e+10, 3.42484503e+10, 4.83237215e+10, &
!     6.83257845e+10, 9.77472664e+10, 1.28957515e+11, 1.48509429e+11, &
!     1.60712526e+11, 1.70442615e+11, 1.79260633e+11, 1.87788230e+11, &
!     1.96208525e+11, 2.04563218e+11, 2.12876461e+11, 2.21161022e+11, &
!     2.29432691e+11, 2.37690387e+11, 2.45945179e+11, 2.54191530e+11, &
!     2.62443599e+11, 2.70688433e+11, 2.78944527e+11, 2.87186482e+11, &
!     2.95443748e+11, 3.03669115e+11, 3.11924701e+11, 3.20074175e+11, 1.61671185e+11/)

! m05f0r model
!!! aver 20-30
!FbdyLeft(:) = (/7.30476224e+09, 1.88393349e+10, 2.04253877e+10, 2.08014127e+10, &
!     1.63406412e+10,  1.18578190e+10,  8.07465657e+09,  6.05071567e+08, &
!    -7.39210336e+08,  2.73416836e+08, -6.09247897e+09, -4.43675596e+10, &
!    -9.42399067e+10, -1.05537609e+11, -1.14048259e+11, -1.22507562e+11, &
!    -1.30790001e+11, -1.39150058e+11, -1.47384480e+11, -1.55652915e+11, &
!    -1.63879343e+11, -1.72126780e+11, -1.80352090e+11, -1.88578633e+11, &
!    -1.96797250e+11, -2.05008005e+11, -2.13225000e+11, -2.21423812e+11, &
!    -2.29652228e+11, -2.37863407e+11, -2.46089406e+11, -2.54290894e+11, &
!    -2.62502235e+11, -2.70687256e+11, -2.78876151e+11, -2.87027630e+11, &
!    -2.95174439e+11, -3.03182891e+11, -3.11013933e+11, -3.18095980e+11, -1.60550009e+11/)
FbdyRight(:) = (/-5.52343838e+09, -2.01016693e+10, -2.16005495e+10, -2.05131492e+10, &
    -1.73880241e+10, -1.17355972e+10, -4.63377388e+09, -9.09563421e+08, &
     1.01648160e+09, -2.03603495e+09,  5.15628980e+09,  4.44914524e+10, &
     9.45275025e+10,  1.05601401e+11,  1.14084793e+11,  1.22511643e+11, &
     1.30768127e+11,  1.39113178e+11,  1.47351120e+11,  1.55625372e+11, &
     1.63849308e+11,  1.72093508e+11,  1.80323019e+11,  1.88547536e+11, &
     1.96760408e+11,  2.04960221e+11,  2.13173208e+11,  2.21384023e+11, &
     2.29615513e+11,  2.37826798e+11,  2.46050995e+11,  2.54250786e+11, &
     2.62461552e+11,  2.70646125e+11,  2.78839550e+11,  2.87005527e+11, &
     2.95149150e+11,  3.03132664e+11,  3.10866434e+11,  3.18107272e+11, 1.60637888e+11/)
!!! aver 30~50
FbdyLeft(:) = (/-1.96026028e+09, -4.77839534e+09, 4.34308738e+09, 1.20018960e+10, &
      8.96979818e+09,  9.88630711e+09,  6.79453265e+09,  1.81284984e+09, &
     -2.53124936e+09, -4.60315779e+09, -1.65056024e+10, -5.62677386e+10, &
     -9.34431038e+10, -1.06871337e+11, -1.15466436e+11, -1.23426603e+11, &
     -1.31548078e+11, -1.39676687e+11, -1.47815484e+11, -1.55969554e+11, &
     -1.64122371e+11, -1.72296353e+11, -1.80473503e+11, -1.88662355e+11, &
     -1.96856713e+11, -2.05054296e+11, -2.13266279e+11, -2.21454993e+11, &
     -2.29646706e+11, -2.37821553e+11, -2.45991043e+11, -2.54138021e+11, &
     -2.62280709e+11, -2.70396605e+11, -2.78492351e+11, -2.86533799e+11, &
     -2.94501151e+11, -3.02334738e+11, -3.10060310e+11, -3.17954124e+11, -1.60910040e+11/)
!FbdyRight(:) = (/4.61174228e+09, 1.94458022e+10, -3.35738681e+09, -1.39604850e+10, &
!     -1.52529040e+10, -1.04622712e+10, -5.36336486e+09, -1.69492925e+09, &
!     2.93839571e+09,  3.83363322e+09, 1.78754973e+10, 6.52642627e+10, &
!     1.00084604e+11,  1.07602571e+11, 1.14738051e+11, 1.22675384e+11, &
!     1.30823224e+11,  1.38975720e+11, 1.47138467e+11, 1.55309371e+11, &
!     1.63489465e+11,  1.71676669e+11, 1.79875387e+11, 1.88074199e+11, &
!     1.96282780e+11,  2.04489404e+11, 2.12705189e+11, 2.20913236e+11, &
!     2.29122125e+11,  2.37312804e+11, 2.45500812e+11, 2.53668401e+11, &
!     2.61835607e+11,  2.69977197e+11, 2.78110547e+11, 2.86173698e+11, &
!     2.94149735e+11,  3.01936741e+11, 3.09554149e+11, 3.16929366e+11, 1.60044008e+11/)
!!! aver 50~120
!FbdyLeft(:) = (/3.84690279e+09, -2.88321980e+09, -6.91570362e+09, -2.51118826e+09, &
!      8.10987728e+09,  4.79278629e+09,  1.96724767e+09,  1.98365901e+09, &
!     -1.06999774e+09, -2.90684797e+09, -1.20804789e+10, -4.57860347e+10, &
!     -8.29181809e+10, -9.61988176e+10, -1.12148214e+11, -1.22678273e+11, &
!     -1.31697745e+11, -1.39775541e+11, -1.47896716e+11, -1.56036276e+11, &
!     -1.64124593e+11, -1.72250543e+11, -1.80382842e+11, -1.88514130e+11, &
!     -1.96655778e+11, -2.04803154e+11, -2.12961947e+11, -2.21114109e+11, &
!     -2.29277506e+11, -2.37440819e+11, -2.45599114e+11, -2.53735410e+11, &
!     -2.61853815e+11, -2.69945705e+11, -2.78022980e+11, -2.86085406e+11, &
!     -2.94168846e+11, -3.02304020e+11, -3.10571898e+11, -3.18905136e+11, -1.61342738e+11/)
!FbdyRight(:) = (/-1.41875198e+09,  4.38542815e+10,  3.19116731e+10, -3.93435835e+09, &
!     -1.41120882e+10, -1.21374013e+10, -5.50145968e+09, -1.52014085e+09, &
!      1.09679954e+09,  6.70693921e+09,  1.03126393e+10,  3.26032764e+10, &
!      7.09178856e+10,  1.02995571e+11,  1.17264348e+11,  1.24483283e+11, &
!      1.31422296e+11,  1.39189684e+11,  1.47307184e+11,  1.55467205e+11, &
!      1.63642134e+11,  1.71813519e+11,  1.79977249e+11,  1.88129688e+11, &
!      1.96283491e+11,  2.04433478e+11,  2.12580537e+11,  2.20718684e+11, &
!      2.28851420e+11,  2.36968824e+11,  2.45075884e+11,  2.53160202e+11, &
!      2.61227239e+11,  2.69259144e+11,  2.77266293e+11,  2.85237045e+11, &
!      2.93214310e+11,  3.01214573e+11,  3.09334278e+11,  3.17662587e+11, 1.60894427e+11/)
!!! aver 600~650
!FbdyLeft(:) = (/-1.73639417e+10, -6.43735623e+10, -4.93663154e+10, -5.74371167e+10, &
!     -6.76837677e+10, -5.25731236e+10, -3.25642199e+10, -1.05273962e+10, &
!     -5.62946217e+09, -8.06422844e+08,  4.76518807e+09,  2.98513573e+09, &
!     -1.83529119e+09, -6.48119799e+09, -7.94243510e+09, -1.23908533e+10, &
!     -2.57172227e+10, -8.40503364e+10, -1.41235354e+11, -1.73772860e+11, &
!     -1.83057087e+11, -1.84600440e+11, -1.85973984e+11, -1.92630956e+11, &
!     -1.99813287e+11, -2.07073277e+11, -2.15028296e+11, -2.23199176e+11, &
!     -2.31234110e+11, -2.39352774e+11, -2.47491214e+11, -2.55724111e+11, &
!     -2.63993444e+11, -2.72206008e+11, -2.80471929e+11, -2.88662314e+11, &
!     -2.96789920e+11, -3.04901077e+11, -3.13048834e+11, -3.21252579e+11, -1.62677882e+11/)
!FbdyRight(:) = (/-1.67966720e+10, -2.60792515e+10, -2.39717316e+10, -2.05573675e+10, &
!    -1.49270756e+10, -8.73018942e+09, -4.02808042e+09 ,  2.44854676e+09, &
!     1.22810501e+10,  2.83370284e+10,  4.00499302e+10,  4.44586847e+10, &
!     4.63012545e+10,  4.61415959e+10,  4.97035350e+10,  6.92150627e+10, &
!     1.09943609e+11,  1.45535411e+11,  1.57719482e+11,  1.63684499e+11, &
!     1.70645390e+11,  1.78138820e+11,  1.85857307e+11,  1.93785038e+11, &
!     2.01998282e+11,  2.10444981e+11,  2.19042294e+11,  2.27707847e+11, &
!     2.36411084e+11,  2.45139852e+11,  2.53883511e+11,  2.62637480e+11, &
!     2.71398814e+11,  2.80166129e+11,  2.88937176e+11,  2.97710623e+11, &
!     3.06482458e+11,  3.15253608e+11,  3.24020473e+11,  3.32782790e+11, 1.68618400e+11/)

drat = dt / dt_elastic
if (drat .lt. 1.) drat = 1.

!$OMP parallel private(i, j, fx, fy, &
!$OMP                  p_est, rosubg, &
!$OMP                  press_norm_l, dlx_l, dly_l, &
!$OMP                  press_norm_r, dlx_r, dly_r, &
!$OMP                  iunknown, rho_water_g, water_depth)
!
!$OMP do
do i = 1,nx
    do j = 1,nz
        if(ynstressbc.eq.0.) then
           force(j,i,1) = 0
           force(j,i,2) = 0
           balance(j,i,1)=0
           balance(j,i,2)=0
        endif
        ! REGULAR PART - forces from stresses
        
        ! Element (j-1,i-1). Triangles B,C,D
        if ( j.ne.1 .and. i.ne.1 ) then
            ! triangle B
            ! side 2-3
            fx = stress0(j-1,i-1,1,2) * (cord(j  ,i  ,2)-cord(j  ,i-1,2)) - &
                 stress0(j-1,i-1,3,2) * (cord(j  ,i  ,1)-cord(j  ,i-1,1))
            fy = stress0(j-1,i-1,3,2) * (cord(j  ,i  ,2)-cord(j  ,i-1,2)) - &
                 stress0(j-1,i-1,2,2) * (cord(j  ,i  ,1)-cord(j  ,i-1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j-1,i-1,1,2) * (cord(j-1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,3,2) * (cord(j-1,i  ,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i-1,3,2) * (cord(j-1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,2,2) * (cord(j-1,i  ,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle C
            ! side 2-3
            fx = stress0(j-1,i-1,1,3) * (cord(j  ,i  ,2)-cord(j  ,i-1,2)) - &
                 stress0(j-1,i-1,3,3) * (cord(j  ,i  ,1)-cord(j  ,i-1,1))
            fy = stress0(j-1,i-1,3,3) * (cord(j  ,i  ,2)-cord(j  ,i-1,2)) - &
                 stress0(j-1,i-1,2,3) * (cord(j  ,i  ,1)-cord(j  ,i-1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j-1,i-1,1,3) * (cord(j-1,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,3,3) * (cord(j-1,i-1,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i-1,3,3) * (cord(j-1,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,2,3) * (cord(j-1,i-1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle D
            ! side 1-2
            fx = stress0(j-1,i-1,1,4) * (cord(j  ,i  ,2)-cord(j-1,i-1,2)) - &
                 stress0(j-1,i-1,3,4) * (cord(j  ,i  ,1)-cord(j-1,i-1,1))
            fy = stress0(j-1,i-1,3,4) * (cord(j  ,i  ,2)-cord(j-1,i-1,2)) - &
                 stress0(j-1,i-1,2,4) * (cord(j  ,i  ,1)-cord(j-1,i-1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 2-3
            fx = stress0(j-1,i-1,1,4) * (cord(j-1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,3,4) * (cord(j-1,i  ,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i-1,3,4) * (cord(j-1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i-1,2,4) * (cord(j-1,i  ,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

        endif

        ! Element (j-1,i). Triangles A,B,C.
        if ( j.ne.1 .and. i.ne.nx ) then
            ! triangle A
            ! side 1-2
            fx = stress0(j-1,i  ,1,1) * (cord(j  ,i  ,2)-cord(j-1,i  ,2)) - &
                 stress0(j-1,i  ,3,1) * (cord(j  ,i  ,1)-cord(j-1,i  ,1))
            fy = stress0(j-1,i  ,3,1) * (cord(j  ,i  ,2)-cord(j-1,i  ,2)) - &
                 stress0(j-1,i  ,2,1) * (cord(j  ,i  ,1)-cord(j-1,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 2-3
            fx = stress0(j-1,i  ,1,1) * (cord(j-1,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,3,1) * (cord(j-1,i+1,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i  ,3,1) * (cord(j-1,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,2,1) * (cord(j-1,i+1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle B
            ! side 1-2
            fx = stress0(j-1,i  ,1,2) * (cord(j  ,i  ,2)-cord(j-1,i+1,2)) - &
                 stress0(j-1,i  ,3,2) * (cord(j  ,i  ,1)-cord(j-1,i+1,1))
            fy = stress0(j-1,i  ,3,2) * (cord(j  ,i  ,2)-cord(j-1,i+1,2)) - &
                 stress0(j-1,i  ,2,2) * (cord(j  ,i  ,1)-cord(j-1,i+1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 2-3
            fx = stress0(j-1,i  ,1,2) * (cord(j  ,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,3,2) * (cord(j  ,i+1,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i  ,3,2) * (cord(j  ,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,2,2) * (cord(j  ,i+1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle C
            ! side 1-2
            fx = stress0(j-1,i  ,1,3) * (cord(j  ,i  ,2)-cord(j-1,i  ,2)) - &
                 stress0(j-1,i  ,3,3) * (cord(j  ,i  ,1)-cord(j-1,i  ,1))
            fy = stress0(j-1,i  ,3,3) * (cord(j  ,i  ,2)-cord(j-1,i  ,2)) - &
                 stress0(j-1,i  ,2,3) * (cord(j  ,i  ,1)-cord(j-1,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 2-3
            fx = stress0(j-1,i  ,1,3) * (cord(j  ,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,3,3) * (cord(j  ,i+1,1)-cord(j  ,i  ,1))
            fy = stress0(j-1,i  ,3,3) * (cord(j  ,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j-1,i  ,2,3) * (cord(j  ,i+1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

        endif
        
        ! Element (j,i-1). Triangles A,B,D
        if ( j.ne.nz .and. i.ne.1 ) then
            ! triangle A
            ! side 2-3
            fx = stress0(j  ,i-1,1,1) * (cord(j  ,i  ,2)-cord(j+1,i-1,2)) - &
                 stress0(j  ,i-1,3,1) * (cord(j  ,i  ,1)-cord(j+1,i-1,1))
            fy = stress0(j  ,i-1,3,1) * (cord(j  ,i  ,2)-cord(j+1,i-1,2)) - &
                 stress0(j  ,i-1,2,1) * (cord(j  ,i  ,1)-cord(j+1,i-1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i-1,1,1) * (cord(j  ,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,3,1) * (cord(j  ,i-1,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i-1,3,1) * (cord(j  ,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,2,1) * (cord(j  ,i-1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle B
            ! side 1-2
            fx = stress0(j  ,i-1,1,2) * (cord(j+1,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,3,2) * (cord(j+1,i-1,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i-1,3,2) * (cord(j+1,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,2,2) * (cord(j+1,i-1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i-1,1,2) * (cord(j  ,i  ,2)-cord(j+1,i  ,2)) - &
                 stress0(j  ,i-1,3,2) * (cord(j  ,i  ,1)-cord(j+1,i  ,1))
            fy = stress0(j  ,i-1,3,2) * (cord(j  ,i  ,2)-cord(j+1,i  ,2)) - &
                 stress0(j  ,i-1,2,2) * (cord(j  ,i  ,1)-cord(j+1,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle D
            ! side 2-3
            fx = stress0(j  ,i-1,1,4) * (cord(j  ,i  ,2)-cord(j+1,i  ,2)) - &
                 stress0(j  ,i-1,3,4) * (cord(j  ,i  ,1)-cord(j+1,i  ,1))
            fy = stress0(j  ,i-1,3,4) * (cord(j  ,i  ,2)-cord(j+1,i  ,2)) - &
                 stress0(j  ,i-1,2,4) * (cord(j  ,i  ,1)-cord(j+1,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i-1,1,4) * (cord(j  ,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,3,4) * (cord(j  ,i-1,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i-1,3,4) * (cord(j  ,i-1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i-1,2,4) * (cord(j  ,i-1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

        endif

        ! Element (j,i). Triangles A,C,D
        if ( j.ne.nz .and. i.ne.nx ) then
            ! triangle A
            ! side 1-2
            fx = stress0(j  ,i  ,1,1) * (cord(j+1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,3,1) * (cord(j+1,i  ,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i  ,3,1) * (cord(j+1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,2,1) * (cord(j+1,i  ,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i  ,1,1) * (cord(j  ,i  ,2)-cord(j  ,i+1,2)) - &
                 stress0(j  ,i  ,3,1) * (cord(j  ,i  ,1)-cord(j  ,i+1,1))
            fy = stress0(j  ,i  ,3,1) * (cord(j  ,i  ,2)-cord(j  ,i+1,2)) - &
                 stress0(j  ,i  ,2,1) * (cord(j  ,i  ,1)-cord(j  ,i+1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle C
            ! side 1-2
            fx = stress0(j  ,i  ,1,3) * (cord(j+1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,3,3) * (cord(j+1,i  ,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i  ,3,3) * (cord(j+1,i  ,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,2,3) * (cord(j+1,i  ,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i  ,1,3) * (cord(j  ,i  ,2)-cord(j+1,i+1,2)) - &
                 stress0(j  ,i  ,3,3) * (cord(j  ,i  ,1)-cord(j+1,i+1,1))
            fy = stress0(j  ,i  ,3,3) * (cord(j  ,i  ,2)-cord(j+1,i+1,2)) - &
                 stress0(j  ,i  ,2,3) * (cord(j  ,i  ,1)-cord(j+1,i+1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

            ! triangle D
            ! side 1-2
            fx = stress0(j  ,i  ,1,4) * (cord(j+1,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,3,4) * (cord(j+1,i+1,1)-cord(j  ,i  ,1))
            fy = stress0(j  ,i  ,3,4) * (cord(j+1,i+1,2)-cord(j  ,i  ,2)) - &
                 stress0(j  ,i  ,2,4) * (cord(j+1,i+1,1)-cord(j  ,i  ,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)
            ! side 3-1
            fx = stress0(j  ,i  ,1,4) * (cord(j  ,i  ,2)-cord(j  ,i+1,2)) - &
                 stress0(j  ,i  ,3,4) * (cord(j  ,i  ,1)-cord(j  ,i+1,1))
            fy = stress0(j  ,i  ,3,4) * (cord(j  ,i  ,2)-cord(j  ,i+1,2)) - &
                 stress0(j  ,i  ,2,4) * (cord(j  ,i  ,1)-cord(j  ,i+1,1))
            force(j,i,1) = force(j,i,1) - 0.25*fx
            force(j,i,2) = force(j,i,2) - 0.25*fy
            balance(j,i,1) = balance(j,i,1) + 0.25*abs(fx)
            balance(j,i,2) = balance(j,i,2) + 0.25*abs(fy)

        endif

        ! GRAVITY FORCE
        force(j,i,2) = force(j,i,2) - rmass(j,i)*g
        balance(j,i,2) = balance(j,i,2) + abs(rmass(j,i)*g)

  enddo
enddo
!$OMP end do

! BOUNDARY CONDITIONS
if(nyhydro.gt.0) then
    !$OMP do
    do i=1,nx

        ! pressure from water sea on top
        rho_water_g = 1030. * g
        if(i.lt.nx) then
            water_depth = 0.5*(cord(1,i+1,2)+cord(1,i,2))
        else
            water_depth = 0.5*(cord(1,i-1,2)+cord(1,i,2))
        endif

        if (water_depth.lt.0.) then ! No water (above sea level)
            if(i.eq.1) then
                press_norm_l = 0
                dlx_l = 0
                dly_l = 0
                press_norm_r = rho_water_g*((cord(1,i+1,2)+cord(1,i,2))/2.)
                dlx_r = cord(1,i+1,1)-cord(1,i  ,1)
                dly_r = cord(1,i+1,2)-cord(1,i  ,2)
            elseif(i.eq.nx) then
                press_norm_l = rho_water_g*((cord(1,i-1,2)+cord(1,i,2))/2.)
                dlx_l = cord(1,i  ,1)-cord(1,i-1,1)
                dly_l = cord(1,i  ,2)-cord(1,i-1,2)
                press_norm_r = 0
                dlx_r = 0
                dly_r = 0
            else
                press_norm_l = rho_water_g*((cord(1,i-1,2)+cord(1,i,2))/2.)
                dlx_l = cord(1,i  ,1)-cord(1,i-1,1)
                dly_l = cord(1,i  ,2)-cord(1,i-1,2)
                press_norm_r = rho_water_g*((cord(1,i+1,2)+cord(1,i,2))/2.)
                dlx_r = cord(1,i+1,1)-cord(1,i  ,1)
                dly_r = cord(1,i+1,2)-cord(1,i  ,2)
            endif
            force(1,i,1) = force(1,i,1)-0.5*press_norm_l*dly_l-0.5*press_norm_r*dly_r
            force(1,i,2) = force(1,i,2)+0.5*press_norm_l*dlx_l+0.5*press_norm_r*dlx_r
            balance(1,i,1) = 1.0d+17
        endif
    enddo
    !$OMP end do

    !$OMP do
    do i=1,nx

        ! bottom support - Archimed force (normal to the surface, shear component = 0)
        p_est = pisos + 0.5*(den(iphsub)+drosub)*g*(cord(nz,i,2)-rzbo)
        rosubg = g * (den(iphsub)+drosub) * (1-alfa(iphsub)*temp(nz,i)+beta(iphsub)*p_est)

        if(i.eq.1) then
            press_norm_l = 0
            dlx_l = 0
            dly_l = 0

            press_norm_r = pisos-rosubg*((cord(nz,i+1,2)+cord(nz,i,2))/2-rzbo)
            dlx_r = cord(nz,i+1,1)-cord(nz,i  ,1)
            dly_r = cord(nz,i+1,2)-cord(nz,i  ,2)
        elseif(i.eq.nx) then
            press_norm_l = pisos-rosubg*((cord(nz,i-1,2)+cord(nz,i,2))/2-rzbo)
            dlx_l = cord(nz,i  ,1)-cord(nz,i-1,1)
            dly_l = cord(nz,i  ,2)-cord(nz,i-1,2)

            press_norm_r = 0
            dlx_r = 0
            dly_r = 0
        else
            press_norm_l = pisos-rosubg*((cord(nz,i-1,2)+cord(nz,i,2))/2-rzbo)
            dlx_l = cord(nz,i  ,1)-cord(nz,i-1,1)
            dly_l = cord(nz,i  ,2)-cord(nz,i-1,2)

            press_norm_r = pisos-rosubg*((cord(nz,i+1,2)+cord(nz,i,2))/2-rzbo)
            dlx_r = cord(nz,i+1,1)-cord(nz,i  ,1)
            dly_r = cord(nz,i+1,2)-cord(nz,i  ,2)
        endif
            
        force(nz,i,1) = force(nz,i,1)-0.5*press_norm_l*dly_l-0.5*press_norm_r*dly_r
        force(nz,i,2) = force(nz,i,2)+0.5*press_norm_l*dlx_l+0.5*press_norm_r*dlx_r

        balance(nz,i,1) = 1.0d+17
        !write(*,*) i,pisos,force(nz,i,1),force(nz,i,2),press_norm_l,press_norm_r,dlx_l,dlx_r,dly_l,dly_r

    enddo
    !$OMP end do
endif
!$OMP end parallel

!do j=1,nz
!    printforce(j) = force(j,nx,1)
!end do
!print *, printforce

! Traction bc for side walls
!! LEFT WALL

! Fbdy calculation
!do j=1,nz
!    if ((time.lt.3.85*1.e3*3.1536e7)) then
!        SumNodeLeft(:) = 0
!        FbdyLeft(:) = 0
!    elseif ((time.gt.3.85*1.e3*3.1536e7 .and. time.lt.5*1.e3*3.1536e7)) then
!        SumNodeLeft(j) = SumNodeLeft(j) + force(j,1,1)
!    end if
!    FbdyLeft(j) = SumNodeLeft(j)/228.0
!end do
!print *, FbdyLeft

do j=1,nz
    rho_mantle_g = 1.e6 !3e8 !3300. * g

    if ((time .lt. 3.85*1e3*3.1536e7)) then
        rho_mantle_g = time*1.e8 / (1*1e6*3.1536e7)

      !if () then ! For every elements in model
        if(j.eq.1) then
            press_norm_u = 0
            dlx_u = 0
            dly_u = 0
            press_norm_d = rho_mantle_g !*((cord(j+1,1,2)+cord(j,1,2))/2.)
            dlx_d = cord(j+1,1,1)-cord(j,1  ,1)
            dly_d = cord(j+1,1,2)-cord(j,1  ,2)
        elseif(j.eq.nz) then
            press_norm_u = rho_mantle_g !*((cord(j-1,1,2)+cord(j,1,2))/2.)
            dlx_u = cord(j,1  ,1)-cord(j-1,1,1)
            dly_u = cord(j,1  ,2)-cord(j-1,1,2)
            press_norm_d = 0
            dlx_d = 0
            dly_d = 0
        else
            press_norm_u = rho_mantle_g !*((cord(j-1,1,2)+cord(j,1,2))/2.)
            dlx_u = cord(j,1  ,1)-cord(j-1,1,1)
            dly_u = cord(j,1  ,2)-cord(j-1,1,2)
            press_norm_d = rho_mantle_g !*((cord(j+1,1,2)+cord(j,1,2))/2.)
            dlx_d = cord(j+1,1,1)-cord(j,1  ,1)
            dly_d = cord(j+1,1,2)-cord(j,1  ,2)
        endif
        force(j,1,1) = 0.5*press_norm_u*dly_u + 0.5*press_norm_d*dly_d
        force(j,1,2) = - 0.5*press_norm_u*dlx_u - 0.5*press_norm_d*dlx_d
        balance(j,1,1) = 1.0d+17

    elseif ((time.gt.3.85*1.e3*3.1536e7 .and. temp(j,1).gt.600.0)) then
        force(j,1,1) = 0.0
        force(j,1,2) = 0.0
        balance(j,1,1) = 1.0d+17

    else
        force(j,1,1) = force(j,1,1) - FbdyLeft(j)
        force(j,1,2) = 0.0
        balance(j,1,1) = 1.0d+17

    end if
end do

!do j=1,nz
!    printforce(j) = force(j,1,1)
!end do
!print *, printforce

!! RIGHT WALL

! Fbdy calculation
!do j=1,nz
!    if ((time.lt.3.85*1.e3*3.1536e7)) then
!        SumNodeRight(:) = 0
!        FbdyRight(:) = 0
!    elseif ((time.gt.3.85*1.e3*3.1536e7 .and. time.lt.5*1.e3*3.1536e7)) then
!        SumNodeRight(j) = SumNodeRight(j) + force(j,nx,1)
!    end if
!    FbdyRight(j) = SumNodeRight(j)/228.0
!end do

do j=1,nz

    if ((time .lt. 3.85*1e3*3.1536e7)) then
        rho_mantle_g = time*1.e8 / (1*1e6*3.1536e7)
        if(j.eq.1) then
            press_norm_u = 0
            dlx_u = 0
            dly_u = 0
            press_norm_d = rho_mantle_g !*((cord(j+1,nx,2)+cord(j,nx,2))/2.)
            dlx_d = cord(j+1,nx,1)-cord(j,nx  ,1)
            dly_d = cord(j+1,nx,2)-cord(j,nx  ,2)
        elseif(j.eq.nz) then
            press_norm_u = rho_mantle_g !*((cord(j-1,nx,2)+cord(j,nx,2))/2.)
            dlx_u = cord(j,nx  ,1)-cord(j-1,nx,1)
            dly_u = cord(j,nx  ,2)-cord(j-1,nx,2)
            press_norm_d = 0
            dlx_d = 0
            dly_d = 0
        else
            press_norm_u = rho_mantle_g !*((cord(j-1,nx,2)+cord(j,nx,2))/2.)
            dlx_u = cord(j,nx  ,1)-cord(j-1,nx,1)
            dly_u = cord(j,nx  ,2)-cord(j-1,nx,2)
            press_norm_d = rho_mantle_g !*((cord(j+1,nx,2)+cord(j,nx,2))/2.)
            dlx_d = cord(j+1,nx,1)-cord(j,nx  ,1)
            dly_d = cord(j+1,nx,2)-cord(j,nx  ,2)
        endif
        force(j,nx,1) = -0.5*press_norm_u*dly_u-0.5*press_norm_d*dly_d
        force(j,nx,2) = 0.5*press_norm_u*dlx_u+0.5*press_norm_d*dlx_d
        balance(j,nx,1) = 1.0d+17

    elseif ((time.gt.3.85*1.e3*3.1536e7 .and. temp(j,nx).gt.600.0)) then
        force(j,nx,1) = 0.0
        force(j,nx,2) = 0.0
        balance(j,nx,1) = 1.0d+17

    else
        force(j,nx,1) = force(j,nx,1) - FbdyRight(j)
        force(j,nx,2) = 0.0
        balance(j,nx,1) = 1.0d+17
    end if
end do            

!do j=1,nz
!    printforce(j) = force(j,nx,1)
!end do
!print *, printforce

!$OMP do reduction(max:boff)
do i=1,nx
    do j=1,nz

        ! BALANCE-OFF
        if( iand(ncod(j,i,1),1).eq.1 .or. j.le.n_boff_cutoff ) then
            balance(j,i,1) = 0
        else
            balance(j,i,1) = abs(force(j,i,1)) / (balance(j,i,1) + 1.0d-9)
        endif

        if( iand(ncod(j,i,2),2).eq.2 .or. j.le.n_boff_cutoff ) then
            balance(j,i,2) = 0
        else
            balance(j,i,2) = abs(force(j,i,2)) / (balance(j,i,2) + 1.0d-9)
        endif

        ! DAMPING
        if( iand(ncod(j,i,1),1).ne.1 .and. abs(vel(j,i,1)).gt.1.0d-13 ) then
            force(j,i,1) = force(j,i,1) - demf*sign(force(j,i,1),vel(j,i,1))
        endif

        if( iand(ncod(j,i,2),2).ne.2 .and. abs(vel(j,i,2)).gt.1.0d-13 ) then
            force(j,i,2) = force(j,i,2) - demf*sign(force(j,i,2),vel(j,i,2))
        endif

        ! VELOCITIES FROM FORCES
        if( ncod(j,i,1) .eq. 1 ) then
            vel(j,i,1) = bc(j,i,1) 
        else
            vel(j,i,1) = vel(j,i,1) + dt*force(j,i,1)/(amass(j,i)*drat*drat)
        endif
        if( ncod(j,i,2) .eq. 1 ) then
            vel(j,i,2) = bc(j,i,2)
        else
            vel(j,i,2) = vel(j,i,2) + dt*force(j,i,2)/(amass(j,i)*drat*drat)
        endif
        ! MAX balance-off
        boff = max(boff,balance(j,i,1))
        boff = max(boff,balance(j,i,2))

    end do
end do
!$OMP end do
! Prestress to form the topo when density differences are present WITHOUT PUSHING OR PULLING!
if (i_prestress.eq.1.and.time.lt.600.e3*sec_year) then
    do k = 1,2
        do i = 1, nx
            vel(nz,i,k) = 0.
        enddo
        do j = 1, nz
            vel(j,1,k) = 0.
            vel(j,nx,k) = 0.
        enddo
    enddo
endif
return
end subroutine fl_node
